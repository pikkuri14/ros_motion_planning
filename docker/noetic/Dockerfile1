# Use the official ROS Noetic base image
FROM osrf/ros:noetic-desktop-full

# Set the working directory
WORKDIR /project

# Install additional dependencies if needed
RUN apt-get update && \
    apt-get -y --no-install-recommends install \
    git \
    gcc \
    cmake \
    make \
    vim \
    psmisc \
    libxml2-dev \
    libxslt-dev \
    python3 \
    python3-pip \
    python-is-python3 \
    ros-noetic-amcl \
    ros-noetic-base-local-planner \
    ros-noetic-map-server \
    ros-noetic-move-base \
    ros-noetic-navfn

# python packages
RUN pip3 install setuptools && pip3 install catkin-tools

# Install OSQP
RUN git clone -b release-0.6.3 --recursive https://github.com/oxfordcontrol/osqp && \
    cd osqp && \
    mkdir build && \
    cd build && \
    cmake .. -DBUILD_SHARED_LIBS=ON && \
    make -j6 && \
    sudo make install && \
    sudo cp /usr/local/include/osqp/* /usr/local/include

# Install OSQP-Eigen
RUN git clone https://github.com/robotology/osqp-eigen.git && \
    cd osqp-eigen && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make && \
    sudo make install

# Source ROS setup.bash
RUN echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc

# Copy the project into the container
COPY . /project

# Build the catkin workspace
RUN /bin/bash -c '. /opt/ros/noetic/setup.bash; catkin_make'

# Set entrypoint to bash to allow easy interaction with the container
ENTRYPOINT ["/bin/bash"]
